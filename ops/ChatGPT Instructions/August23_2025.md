# Diagrams Task Pack — Visual Maps & Routing (Code ↔ Appwrite ↔ External)

The following **Cursor prompts** generate the repo map, functional flows, and API/routing maps, then surface gaps between what’s coded vs what actually works. Run them in order.

## Prompt 1 — Discover existing diagrams & config
**Paste in Cursor:**

> Scan the repo for existing diagrams/config to avoid duplication:
> 1) List files under `docs/diagrams/**` **and** `doc/diagrams/**` (both spellings), plus any `app/(admin)/diagrams` or `app/admin/diagrams` routes.
> 2) Open the “diagrams admin page” that renders Mermaid/runtime fetch. Identify the expected JSON shape and fetch endpoint(s).
> 3) Produce a summary file `docs/diagrams/_inventory.json` with:
>    - `existing`: array of { path, title?, type: (project|functional|api|other) }
>    - `fetch_shape`: example JSON the admin page expects
>    - `todo`: empty array for now
> 4) Reply with a bullet list of what already exists and what is missing.

---

## Prompt 2 — Generate **Project Maps** for root directories (auto-discovery)
**Paste in Cursor:**

> Create `ops/diagrams/generateProjectMaps.ts` that:
> 1) Detects top-level directories in repo root, excluding `node_modules`, `.next`, `.turbo`, `.git`, `dist`, `build`.
> 2) For each root dir (e.g., `app`, `components`, `lib`, `schema`, `functions`, `ops`, `docs`, `public`, `future`, and any 10th+ discovered):
>    - Walk up to depth 3; count files by type; capture notable entrypoints (e.g., `app/layout.tsx`, `functions/appwrite/**`).
>    - Build a Mermaid **mindmap** and **flowchart** that shows subfolders and key files.
> 3) Write output to `docs/diagrams/project/<root>.md` with two fenced code blocks: ```mermaid mindmap``` and ```mermaid graph TD```.
> 4) Emit an index file `docs/diagrams/project/_index.md` linking to each map.
> 5) Idempotent + pretty formatting. Add npm script: `"diagrams:project": "tsx ops/diagrams/generateProjectMaps.ts"`.
>
> Then run the generator and update `docs/diagrams/_inventory.json.todo` with the created paths.

---

## Prompt 3 — Functional Flow: **Create Account** (flow + sequence + data map)
**Paste in Cursor:**

> Create `ops/diagrams/functional/createAccount.ts` that outputs `docs/diagrams/functional/create-account.md` containing **three** diagrams:
> 1) **Flowchart**: user → Next.js route → Auth (Google/Appwrite) → DAL → `clients` (create) → redirect.
> 2) **Sequence diagram**: Component → `/api/auth/callback` (or Appwrite session) → DAL → Appwrite (`clients` upsert) → Activity log.
> 3) **Data interaction table** (markdown): columns: Collection | Read/Write | Attributes set | Notes. Include `clients`, `activity_log`.
> Also: parse code to auto-detect the actual auth route handlers and include their paths at the top of the doc.

---

## Prompt 4 — Functional Flow: **Create League** (with Draft Scheduling)
**Paste in Cursor:**

> Create `ops/diagrams/functional/createLeague.ts` → `docs/diagrams/functional/create-league.md` with:
> 1) **Flowchart**: UI form → API route → DAL → `leagues` (create) + schedule fields → `league_memberships` (owner) → redirect to league dashboard.
> 2) **Sequence**: Component → `/api/leagues/create` → DAL → Appwrite. Include validation & normalization of scheduling.
> 3) **Data map table**: `leagues` (W), `league_memberships` (W), `activity_log` (W).
> 4) **Include & persist these attributes on `leagues`:**
>    - `draft_type` (`snake|auction`)
>    - `draft_start_at` (ISO datetime, required for real drafts)
>    - `draft_room_open_offset_minutes` (default `60` → room opens 1h before)
>    - `pick_time_seconds` (per-pick clock)
>    - `draft_order_json` (array of `fantasy_team_id`)
>    - `scoring_rules` (stringified JSON)
> 5) **Derive & store**: `draft_room_open_at = draft_start_at - offset` (server-side in UTC; also store `timezone` if available).
> 6) **Add index** (optional but recommended): `(season, draft_start_at)` on `leagues`.
> 7) **Diagram note**: annotate status gates (room closed → room open (read-only) → live draft).
---

## Prompt 5 — Functional Flow: **Join League (Invite)**
**Paste in Cursor:**

> Create `ops/diagrams/functional/joinLeague.ts` → `docs/diagrams/functional/join-league.md` with:
> 1) Flowchart: open invite link → verify `invites.token` → `league_memberships` upsert → redirect.
> 2) Sequence: Component → `/api/invites/accept` → DAL → Appwrite.
> 3) Data map: `invites` (R/U), `league_memberships` (W), `activity_log` (W).

---

## Prompt 6 — Functional Flow: **Draft (Mock vs Real, Scheduled)**
**Paste in Cursor:**

> Create `ops/diagrams/functional/draft.ts` → `docs/diagrams/functional/draft.md` with **two separate flows** and a shared UI note:
>
> ### A) Mock Draft (no season commits)
> 1) **Flowchart**: start mock → `drafts.is_mock=true` → generate order → users pick → write `draft_events(type='pick')` + update `draft_states` → finish.
> 2) **Sequence**: Component/WebSocket → `/api/drafts/mock/*` → DAL → Appwrite: `drafts` (R/W), `draft_states` (W), `draft_events` (W), `activity_log` (W). **Do NOT** write `roster_slots` or `transactions`.
> 3) **UI**: identical to real draft (same components), but top banner labeled “Mock Draft”; allow reset/restart; persist board optionally under `drafts.board_md` for review but **not** linked to season.
>
> ### B) Real Draft (scheduled, commits to season)
> 1) **Gatekeeping**: room opens **1 hour** before start → users can enter and see their **pick #** from `leagues.draft_order_json`; timer and pick actions remain **disabled**.
> 2) **At `now >= draft_start_at`**: enable clock & picks; update `draft_states` every tick or event.
> 3) **On pick**: write `draft_events(type='pick')` → update `draft_states` → **commit** player to team: `roster_slots` (W), optional `transactions(type='draft')` (W), update `fantasy_teams.auction_budget_remaining` (if auction).
> 4) **On finish**: mark `drafts.status='completed'` → **generate static draft board** (Mermaid) and store:
>    - File: `docs/diagrams/draft-boards/<league_id>-<season>.md` **and**
>    - Add `drafts.board_asset_uri` (if also uploaded to storage/CDN).
> 5) **Sequence**: Component/WebSocket → `/api/drafts/*` → DAL → Appwrite: `drafts`, `draft_states`, `draft_events`, `roster_slots`, `transactions`, `activity_log`.
>
> ### Shared UI & Timing
> - UI components are **identical** between Mock and Real.
> - Add a `GET /api/drafts/:id/room-state` that returns `{ now, draft_start_at, draft_room_open_at, isOpen, isLive, server_tz }` to control gating client-side.
> - Add middleware or server guard to reject pick attempts before `isLive`.
>
> ### Deliverables
> - **Flowchart** for A & B, **Sequence** for both, **Data map** table showing differences (Mock vs Real columns).
> - **Script**: `ops/diagrams/generateDraftBoard.ts` that reads `draft_events` for a completed draft and emits a Mermaid board saved to `docs/diagrams/draft-boards/…`. Also set `drafts.board_asset_uri`.
> - **Indexes**: ensure `draft_events (draft_id, overall)` and `draft_states (draft_id unique)` exist.
> - **Tests**: add unit tests for gating logic around `draft_room_open_at` and `draft_start_at`. 
---

## Prompt 7 — Functional Flow: **Commissioner Settings** (scheduling, order, scoring)
**Paste in Cursor:**

> Create `ops/diagrams/functional/commishSettings.ts` → `docs/diagrams/functional/commish-settings.md` with:
> 1) **Flowchart**: open Commish page → edit settings → validate → write `leagues` (U) → notify members.
> 2) **Sequence**: Component → `/api/leagues/update` → DAL → Appwrite.
> 3) **Data map**: `leagues` (U), `activity_log` (W).
> 4) **Fields editable** (persist in `leagues`):
>    - `draft_type`, `draft_start_at`, `draft_room_open_offset_minutes`, `pick_time_seconds`
>    - `draft_order_json` (array of team IDs reflecting displayed pick # in room)
>    - `scoring_rules`
> 5) **Derived**: update `draft_room_open_at` on every save.
> 6) **Gating preview**: show status chip **Closed / Opens at / Live at** using computed server times.
> 7) **Notifications**: create a stub `notifyDraftScheduleChanged(league_id)` to inform members (email/WS/in-app) when schedule changes.
> 8) **Diagram note**: link to Prompt 6 gating checks so flows stay in sync.
---

## Prompt 8 — Functional Flow: **Projections**
**Paste in Cursor:**

> Create `ops/diagrams/functional/projections.ts` → `docs/diagrams/functional/projections.md` with:
> 1) Flowchart: trigger run (manual/cron) → `model_runs` (start) → fetch inputs (external + `college_players`, `games`, `player_stats`) → compute → write `projections` → `model_runs` (finish).
> 2) Sequence: Cron/CLI → `ops` runner → DAL → external APIs (CFBD/ESPN/Rotowire) → Appwrite.
> 3) Data map: `model_versions` (R), `model_runs` (W/U), `projections` (W), `player_stats` (R), `college_players` (R), `games` (R).
> 4) Include placeholders for `weights_json`, `inputs_json`, `metrics_json`.

---

## Prompt 9 — API & Routing Maps (internal, external, data sources)
**Paste in Cursor:**

> Create `ops/diagrams/generateApiRoutingMaps.ts` that outputs:
> 1) `docs/diagrams/api/routes.md` — Next.js/app routes: pages in `app/**` (server actions), `/api/**` handlers, and `functions/appwrite/**`. Build a Mermaid **graph LR** with edges: Component → API → DAL → Appwrite collections.
> 2) `docs/diagrams/api/external.md` — external providers used: CFBD, ESPN, Rotowire, Meshy, Google Auth. For each, list the code modules that call them and the collections they influence.
> 3) `docs/diagrams/api/data-sources.md` — per function, map which sources are read/written (external, codebase modules, Appwrite collections). Include tables.
> Implementation details:
> - Use `ts-morph` to parse imports and find references to `Databases.createDocument/listDocuments/updateDocument` etc. to infer collection names.
> - Detect Next.js routes by scanning `app/**/route.ts` and `app/**/page.tsx` plus server actions (`"use server"`).
> - Detect Appwrite functions under `functions/appwrite/**`.
> - Emit Mermaid graphs and markdown tables.

---

## Prompt 10 — **Coded vs Working** report (stale/broken detection)
**Paste in Cursor:**

> Create `ops/diagrams/reportCodedVsWorking.ts` that:
> 1) Builds an **import graph** for the repo using `ts-morph`. Mark nodes reachable from `app/layout.tsx`, `app/page.tsx`, `app/**/page.tsx`, API routes, and `functions/appwrite/**` as **reachable**.
> 2) Flags **orphaned**/unreachable files under `components`, `lib`, `app/(routes)`.
> 3) Cross-checks references to legacy collections (e.g., `teams`, `users`, `user_teams`, `draft_picks`, etc.) and lists where they still appear.
> 4) Optionally (if Playwright installed) add a simple fetch suite to ping top routes and record HTTP status (write `docs/diagrams/runtime/route-status.json`).
> 5) Output `docs/diagrams/report.md` with:
>    - Summary counts (reachable vs orphaned)
>    - Table of files referencing legacy collections
>    - Table of missing routes/handlers detected by static analysis
>    - Links to each generated diagram
>
> Add npm script: `"diagrams:report": "tsx ops/diagrams/reportCodedVsWorking.ts"`.

---

## Prompt 11 — Wire diagrams into the Admin page
**Paste in Cursor:**

> Update the diagrams admin page to auto-load new outputs:
> 1) Read `docs/diagrams/_inventory.json` and show sections: Project, Functional, API, Reports.
> 2) Add a dropdown to choose diagram type and file; render Markdown with Mermaid blocks.
> 3) Add a **debug panel** toggle that shows the raw JSON used to render.
> 4) Provide deep links (hashes) so we can share specific diagrams.

---

## Prompt 12 — Scaffolds for upcoming features (TODO diagrams)
**Paste in Cursor:**

> Create stubs under `docs/diagrams/functional/todo/` for:
> - `waivers.md` (flow + sequence + data map)
> - `trading.md`
> - `save-roster.md`
> - `rankings-and-conference-locks.md` (P4 mode)
> Include FIXME notes for the exact API endpoints once implemented.

---

## Prompt 13 — Run generators & produce one consolidated index
**Paste in Cursor:**

> 1) Run: `npm run diagrams:project` → `npm run diagrams:report`.
> 2) Add a small `ops/diagrams/buildIndex.ts` that scans `docs/diagrams/**` and outputs `docs/diagrams/index.md` with a categorized list and timestamps.
> 3) Open a PR titled **“Diagrams: project, functional, routing + coded-vs-working report”** including all generated files.



---

# Working Session Summary — College Football Fantasy App
**Date:** 2025-08-23

This note summarizes the two major tasks we completed/organized today: **(1) Database schema consolidation (42 → 24)** and **(2) Diagrams & routing maps Task Pack**. Use this as a compact reference for your repo and team.

## 1) Database Schema Consolidation (42 → 24) — Completed
**Objective:** Consolidate overlapping/legacy collections into a clean, consistent schema without breaking the app.

### Key Outcomes
1. **Renames & Keeps**
   - `users` → **clients** (auth-linked profile)
   - `teams` → **schools** (real CFB schools)
   - `user_teams` → **fantasy_teams`
   - `rosters` → **roster_slots**
   - `scores` → **matchups**
   - **kept:** `drafts`, `draft_states`, `draft_events`, `transactions`, `games`, `rankings`, `college_players`, `meshy_jobs`

2. **Projections Unification**
   - `player_projections`, `projections_weekly`, `projections_yearly`, `user_custom_projections` → **projections** (with `period`, `version`, `source`, optional `client_id`)
   - `projection_runs` → **model_runs** (embedded `inputs_json`, `weights_json`, `metrics_json`)
   - **model_versions** retained for versioned weights/artifacts

3. **Auctions**
   - Auction mode modeled with `drafts(type='auction')`, `auctions` (lots), and `bids` (merged `auction_bids`).

### Migration Highlights
1. **SSOT defined** (target 24 collections, attributes, indexes).
2. **Create scripts** (idempotent) and **migrations** (paged) generated.
3. **Dual-write DAL** + feature flag to keep app live during backfill.
4. **Parity checks** and **cut-over** performed.
5. **Decommission**: backups taken, dual-write removed, legacy collections cleaned from code.

### Files Produced
- **schema_mapping.json** — old→new actions and notes (see repo and ops/out)
- **target_schema_outline.json** — target 24 collections (attrs + indexes)

### Post-Cutover Notes
- Monitor logs & activity for anomalies.
- Tag release after stability window.

---

## 2) Diagrams & Routing Maps — In Progress (Prompts in Canvas)
**Objective:** Make the project transparent by auto-generating visual maps of repo structure, functional flows, and code↔API↔Appwrite↔external routing; then flag gaps between “coded vs working”.

### Deliverables (Prompts 1–13 in this canvas)
1. **Discovery:** Inventory existing diagrams/admin page expectations.
2. **Project Maps:** Mermaid mindmaps + flowcharts for each root (`app`, `components`, `lib`, `schema`, `functions`, `ops`, `docs`, `public`, `future`, + any others).
3. **Functional Flows:**
   1) Create Account
   2) Create League (**with scheduling**: `draft_start_at`, `draft_room_open_offset_minutes`, `pick_time_seconds`, `draft_order_json`, `scoring_rules` → derive `draft_room_open_at`)
   3) Join League (Invite flow)
   4) **Draft (Mock vs Real, scheduled)**  
      - **Mock:** identical UI; writes `draft_events` only (no roster commits).  
      - **Real:** room opens read-only **1 hour** before; at `draft_start_at` enable picks; commit to `roster_slots`/`transactions`; on finish, save a **static draft board** (Mermaid) for season reference.
      - Shared endpoint: `GET /api/drafts/:id/room-state` returns `{now, draft_start_at, draft_room_open_at, isOpen, isLive, server_tz}`; server guard rejects picks before live.
   5) **Commissioner Settings:** scheduling, order, scoring; live status chips; member notifications.
   6) **Projections (Yearly & Weekly):**
      - **Inputs:** depth charts (data/), EA ratings (data/), aggregated mock drafts (data/), CFBD/ESPN/Rotowire, weather, SOS, historical/current stats.
      - **Weekly:** season-synced; injuries, weather, SOS; scoring overlay per league (`scoring_rules`); consider base vs league-adjusted storage strategy.
      - **Weight-tuning loop:** iterate weights, evaluate (MAE/MAPE/Spearman), lock best version in `model_versions`; store run details in `model_runs`.

4. **API & Routing Maps:** Components → API routes → DAL → Appwrite collections; external providers (CFBD/ESPN/Rotowire/Meshy/Auth).
5. **“Coded vs Working” Report:** Import graph, orphaned files, legacy collection references, optional runtime route status.
6. **Admin Page Wiring:** Auto-load/render new diagrams with Mermaid + debug panel.
7. **Consolidated Index & PR script.**

### Next Steps (Short)
1. Run **Prompt 1 → 3** to bootstrap diagrams for Create Account/League and inventory admin page.
2. Run **Prompt 6** to generate Draft (Mock vs Real) diagrams and the draft-board export script.
3. Run **Prompt 8** to scaffold Projections inputs/engine/evaluation/scoring overlay.
4. Run **Prompt 9–13** to produce routing maps, the coded-vs-working report, and the consolidated index PR.

---

## Quick Checklist
- [x] Schema consolidation plan finalized (42 → 24) and executed
- [x] Decommission legacy schema/code after verification
- [ ] Generate & review **Project Maps**
- [ ] Generate **Functional** diagrams (Create Account/League/Join/Draft/Commish/Projections)
- [ ] Generate **API & Routing** maps
- [ ] Run **Coded vs Working** report and clean orphans/legacy refs
- [ ] Wire into **Diagrams Admin** and open PR

---

