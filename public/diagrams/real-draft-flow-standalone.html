<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Draft Flow - League Season Draft</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            min-height: 100vh;
            color: #1a202c;
            padding: 2rem;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 3rem;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.95;
        }
        
        .content-card {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .diagram-container {
            background: #fafafa;
            border-radius: 0.5rem;
            padding: 2.5rem;
            margin-bottom: 2rem;
            overflow-x: auto;
        }
        
        .mermaid {
            display: flex;
            justify-content: center;
        }
        
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .feature-card {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            padding: 1.5rem;
            border-radius: 0.5rem;
            border-left: 4px solid #3b82f6;
        }
        
        .feature-card h3 {
            color: #1e3a8a;
            margin-bottom: 0.75rem;
            font-size: 1.1rem;
        }
        
        .feature-card ul {
            list-style: none;
            padding-left: 0;
        }
        
        .feature-card li {
            padding: 0.25rem 0;
            position: relative;
            padding-left: 1.5rem;
        }
        
        .feature-card li:before {
            content: "‚Üí";
            position: absolute;
            left: 0;
            color: #3b82f6;
        }
        
        .commit-box {
            background: #dcfce7;
            border: 2px solid #10b981;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-top: 2rem;
        }
        
        .commit-box h3 {
            color: #14532d;
            margin-bottom: 0.5rem;
        }
        
        .commit-list {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }
        
        .commit-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #166534;
            font-weight: 500;
        }
        
        .timing-visual {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 2rem;
            background: linear-gradient(to right, #fee2e2, #fef3c7, #dcfce7);
            border-radius: 0.5rem;
            margin: 1.5rem 0;
        }
        
        .timing-phase {
            text-align: center;
            flex: 1;
            padding: 1rem;
            position: relative;
        }
        
        .timing-phase:not(:last-child):after {
            content: '‚Üí';
            position: absolute;
            right: -1rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5rem;
            color: #6b7280;
        }
        
        .phase-time {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }
        
        .phase-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }
        
        .phase-desc {
            font-size: 0.875rem;
            color: #4b5563;
        }
        
        .code-block {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1.5rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 1rem 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        .code-block .comment {
            color: #94a3b8;
        }
        
        .code-block .keyword {
            color: #a78bfa;
        }
        
        .code-block .string {
            color: #86efac;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÜ Real Draft Flow</h1>
            <p>Official league draft with scheduled timing and season commitments</p>
        </div>
        
        <div class="content-card">
            <h2>Real Draft Process Flow</h2>
            <div class="diagram-container">
                <div class="mermaid">
graph TD
    A[Scheduled Draft Time] --> B{Check Current Time}
    B -->|T-60min| C[Draft Room Opens]
    C --> D[Read-Only Preview Mode]
    D --> E[Show Draft Position]
    E --> F[Show Countdown Timer]
    
    B -->|T=0| G[Draft Goes Live]
    G --> H[Enable Pick Clock]
    H --> I[Enable Pick Actions]
    
    I --> J{User Turn?}
    J -->|Yes| K[Pick Window Open]
    J -->|No| L[Watch Only]
    
    K --> M{Timer Expired?}
    M -->|No| N[User Selects Player]
    M -->|Yes| O[Auto-Pick BPA]
    
    N --> P[Validate Pick]
    O --> P
    
    P --> Q[Write draft_picks]
    Q --> R[Update draft_states]
    R --> S[Write roster_slots]
    S --> T[Write transactions]
    T --> U[Update budget if auction]
    
    U --> V[Next Pick]
    V --> W{Draft Complete?}
    W -->|No| J
    W -->|Yes| X[Finalize Draft]
    
    X --> Y[Mark status completed]
    Y --> Z[Generate Board]
    Z --> AA[Save to draft-boards]
    AA --> AB[Notify All Users]
    
    style A fill:#dbeafe
    style G fill:#fbbf24
    style X fill:#10b981
    style O fill:#fee2e2
                </div>
            </div>
            
            <div class="timing-visual">
                <div class="timing-phase">
                    <div class="phase-time">Before T-60min</div>
                    <div class="phase-title">üîí Room Closed</div>
                    <div class="phase-desc">No access</div>
                </div>
                <div class="timing-phase">
                    <div class="phase-time">T-60min to T-0</div>
                    <div class="phase-title">üëÅÔ∏è Preview Mode</div>
                    <div class="phase-desc">Read-only access</div>
                </div>
                <div class="timing-phase">
                    <div class="phase-time">T-0 onwards</div>
                    <div class="phase-title">‚úÖ Draft Live</div>
                    <div class="phase-desc">Full functionality</div>
                </div>
            </div>
            
            <div class="features-grid">
                <div class="feature-card">
                    <h3>üìÖ Scheduled Draft</h3>
                    <ul>
                        <li>Pre-scheduled date & time</li>
                        <li>60-minute preview window</li>
                        <li>Automatic room opening</li>
                        <li>Countdown timer display</li>
                        <li>Time zone handling</li>
                    </ul>
                </div>
                <div class="feature-card">
                    <h3>‚è±Ô∏è Pick Management</h3>
                    <ul>
                        <li>Configurable pick timer (30-180s)</li>
                        <li>Auto-pick on timer expiry</li>
                        <li>Commissioner pause/resume</li>
                        <li>Real-time WebSocket updates</li>
                        <li>Pick validation & rules</li>
                    </ul>
                </div>
                <div class="feature-card">
                    <h3>üîê Access Control</h3>
                    <ul>
                        <li>Three-phase access system</li>
                        <li>Room state management</li>
                        <li>User turn enforcement</li>
                        <li>Commissioner controls</li>
                        <li>One-time event (no reset)</li>
                    </ul>
                </div>
            </div>
            
            <div class="commit-box">
                <h3>‚úÖ Season Commitments</h3>
                <p>Real drafts create permanent season data that cannot be undone:</p>
                <div class="commit-list">
                    <div class="commit-item">
                        <span>‚úÖ</span>
                        <span>roster_slots created</span>
                    </div>
                    <div class="commit-item">
                        <span>‚úÖ</span>
                        <span>transactions recorded</span>
                    </div>
                    <div class="commit-item">
                        <span>‚úÖ</span>
                        <span>budgets updated</span>
                    </div>
                    <div class="commit-item">
                        <span>‚úÖ</span>
                        <span>permanent rosters</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="content-card">
            <h2>Implementation Code</h2>
            <div class="code-block">
<span class="comment">// Real Draft with Timing Gates</span>
<span class="keyword">async function</span> initializeRealDraft(leagueId: string) {
  <span class="keyword">const</span> draft = <span class="keyword">await</span> getDraft(leagueId)
  <span class="keyword">const</span> now = <span class="keyword">new</span> Date()
  
  <span class="comment">// Calculate room state based on time</span>
  <span class="keyword">const</span> roomOpenTime = <span class="keyword">new</span> Date(draft.draft_room_open_at)
  <span class="keyword">const</span> draftStartTime = <span class="keyword">new</span> Date(draft.draft_start_at)
  
  <span class="keyword">if</span> (now < roomOpenTime) {
    <span class="keyword">return</span> {
      status: <span class="string">'closed'</span>,
      message: <span class="string">'Room opens at '</span> + roomOpenTime.toLocaleString()
    }
  }
  
  <span class="keyword">if</span> (now < draftStartTime) {
    <span class="keyword">return</span> {
      status: <span class="string">'preview'</span>,
      readOnly: <span class="keyword">true</span>,
      countdown: draftStartTime - now
    }
  }
  
  <span class="comment">// Draft is live - enable all features</span>
  <span class="keyword">await</span> enableDraftControls(draft.id)
  <span class="keyword">await</span> startPickClock(draft.pick_time_seconds)
  
  <span class="keyword">return</span> {
    status: <span class="string">'live'</span>,
    canPick: <span class="keyword">true</span>,
    currentPick: <span class="keyword">await</span> getCurrentPick(draft.id)
  }
}

<span class="comment">// Commit pick to season (permanent)</span>
<span class="keyword">async function</span> commitRealPick(pick: DraftPick) {
  <span class="comment">// Write to multiple collections for season persistence</span>
  <span class="keyword">await</span> Promise.all([
    writeDraftPick(pick),           <span class="comment">// Pick history</span>
    createRosterSlot(pick),          <span class="comment">// Permanent roster</span>
    recordTransaction(pick),         <span class="comment">// Transaction log</span>
    updateTeamBudget(pick),         <span class="comment">// Auction budget</span>
    updateDraftState(pick.draftId), <span class="comment">// Current state</span>
    broadcastUpdate(pick)           <span class="comment">// Real-time update</span>
  ])
}

<span class="comment">// Auto-pick on timer expiration</span>
<span class="keyword">async function</span> executeAutopick(draftId: string, teamId: string) {
  <span class="keyword">const</span> available = <span class="keyword">await</span> getAvailablePlayers(draftId)
  <span class="keyword">const</span> roster = <span class="keyword">await</span> getTeamRoster(teamId)
  
  <span class="comment">// Apply BPA strategy with position balancing</span>
  <span class="keyword">const</span> selected = selectBestPlayerAvailable(available, roster)
  
  <span class="comment">// Commit the auto-pick</span>
  <span class="keyword">await</span> commitRealPick({
    draftId,
    teamId,
    playerId: selected.id,
    isAutopick: <span class="keyword">true</span>
  })
}
            </div>
        </div>
        
        <div class="content-card">
            <h2>Timing Gates Configuration</h2>
            <div class="code-block">
<span class="comment">// Room State API Response</span>
<span class="keyword">interface</span> RoomStateResponse {
  now: string              <span class="comment">// Server time ISO</span>
  draft_start_at: string   <span class="comment">// Scheduled draft time</span>
  draft_room_open_at: string <span class="comment">// Room opens (T-60min)</span>
  isOpen: boolean          <span class="comment">// Can enter room</span>
  isLive: boolean          <span class="comment">// Can make picks</span>
  isComplete: boolean      <span class="comment">// Draft finished</span>
  server_tz: string        <span class="comment">// Server timezone</span>
  timeToOpen?: number      <span class="comment">// Milliseconds until open</span>
  timeToStart?: number     <span class="comment">// Milliseconds until live</span>
}

<span class="comment">// Calculate draft room open time</span>
<span class="keyword">const</span> draft_room_open_at = <span class="keyword">new</span> Date(
  <span class="keyword">new</span> Date(draft_start_at).getTime() - 
  (60 * 60 * 1000) <span class="comment">// 60 minutes before</span>
).toISOString()
            </div>
        </div>
    </div>
    
    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
                primaryColor: '#3b82f6',
                primaryTextColor: '#1a202c',
                primaryBorderColor: '#1e40af',
                lineColor: '#3b82f6',
                secondaryColor: '#dbeafe',
                tertiaryColor: '#bfdbfe'
            }
        });
    </script>
</body>
</html>