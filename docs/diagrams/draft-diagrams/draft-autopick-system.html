<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Draft Autopick System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);
            min-height: 100vh;
            color: #1a202c;
            padding: 2rem;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 3rem;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.95;
        }
        
        .content-card {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .diagram-container {
            background: #fafafa;
            border-radius: 0.5rem;
            padding: 2.5rem;
            margin-bottom: 2rem;
            overflow-x: auto;
        }
        
        .mermaid {
            display: flex;
            justify-content: center;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .info-card {
            background: linear-gradient(135deg, #fdf4ff 0%, #fae8ff 100%);
            padding: 1.5rem;
            border-radius: 0.5rem;
            border-left: 4px solid #ec4899;
        }
        
        .info-card h3 {
            color: #a21caf;
            margin-bottom: 0.75rem;
            font-size: 1.1rem;
        }
        
        .info-card ul {
            list-style: none;
            padding-left: 0;
        }
        
        .info-card li {
            padding: 0.25rem 0;
            position: relative;
            padding-left: 1.5rem;
        }
        
        .info-card li:before {
            content: "‚Üí";
            position: absolute;
            left: 0;
            color: #ec4899;
        }
        
        .code-block {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1.5rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 1rem 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        .code-block .comment {
            color: #94a3b8;
        }
        
        .code-block .keyword {
            color: #c084fc;
        }
        
        .code-block .string {
            color: #86efac;
        }
        
        .code-block .function {
            color: #60a5fa;
        }
        
        .strategy-card {
            background: white;
            border: 2px solid #ec4899;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin: 1rem 0;
            transition: transform 0.3s ease;
        }
        
        .strategy-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .strategy-title {
            color: #a21caf;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .strategy-desc {
            color: #64748b;
            margin-bottom: 1rem;
        }
        
        .priority-list {
            background: #f8f9fa;
            border-radius: 0.25rem;
            padding: 1rem;
        }
        
        .priority-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .priority-item:last-child {
            border-bottom: none;
        }
        
        .priority-rank {
            background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 1rem;
        }
        
        .timeline {
            position: relative;
            padding: 2rem 0;
        }
        
        .timeline-item {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
            position: relative;
        }
        
        .timeline-item:not(:last-child):after {
            content: '';
            position: absolute;
            left: 2rem;
            top: 3.5rem;
            width: 2px;
            height: 2rem;
            background: linear-gradient(to bottom, #ec4899, transparent);
        }
        
        .timeline-icon {
            width: 4rem;
            height: 4rem;
            border-radius: 50%;
            background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            margin-right: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .timeline-content {
            flex: 1;
        }
        
        .timeline-title {
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 0.25rem;
        }
        
        .timeline-desc {
            color: #64748b;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Draft Autopick System</h1>
            <p>Intelligent autopick orchestration with three-tier failsafe</p>
        </div>
        
        <div class="content-card">
            <h2>Autopick Orchestration Flow</h2>
            <div class="diagram-container">
                <div class="mermaid">
sequenceDiagram
    participant UI as Draft Room UI
    participant API as API Routes
    participant DB as Database
    participant Fn as Serverless Function
    participant Cron as Cron Job

    rect rgb(255, 240, 240)
        note over UI,Fn: PRIMARY: TIMER EXPIRATION
        note over UI: When timer hits 0:00
        UI->>API: POST /api/drafts/:id/autopick
        API->>DB: Acquire lock on draft
        API->>DB: Validate current state
        API->>DB: Execute autopick
        API->>DB: Write pick to database
        API->>DB: Advance to next pick
        API->>DB: Release lock
        API-->>UI: Pick confirmed
    end

    alt No clients connected
        rect rgb(240, 248, 255)
            note over DB,Fn: SECONDARY: SERVERLESS FALLBACK
            DB-->>Fn: draft_states update event triggered
            Fn->>DB: Scan for expired timers
            Fn->>DB: Find drafts with deadline < now()
            Fn->>API: POST /api/drafts/:id/autopick
            API->>DB: Execute autopick with lock
            DB-->>Fn: Pick completed
        end
    else Periodic safety net
        rect rgb(255, 250, 240)
            note over Cron: TERTIARY: CRON SAFETY NET
            Cron->>Cron: Every minute check
            Cron->>DB: Query expired deadlines
            Cron->>DB: WHERE deadline < NOW()
            Cron->>API: POST /api/drafts/:id/autopick
            API->>DB: Execute autopick with lock
            DB-->>Cron: Batch completed
        end
    end
                </div>
            </div>
            
            <div class="timeline">
                <div class="timeline-item">
                    <div class="timeline-icon">1Ô∏è‚É£</div>
                    <div class="timeline-content">
                        <div class="timeline-title">Primary: Client Timer</div>
                        <div class="timeline-desc">UI detects timer expiration and triggers autopick immediately</div>
                    </div>
                </div>
                <div class="timeline-item">
                    <div class="timeline-icon">2Ô∏è‚É£</div>
                    <div class="timeline-content">
                        <div class="timeline-title">Secondary: Serverless Function</div>
                        <div class="timeline-desc">Database event triggers function to check for expired picks</div>
                    </div>
                </div>
                <div class="timeline-item">
                    <div class="timeline-icon">3Ô∏è‚É£</div>
                    <div class="timeline-content">
                        <div class="timeline-title">Tertiary: Cron Job</div>
                        <div class="timeline-desc">Runs every minute as ultimate safety net</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="content-card">
            <h2>Autopick Strategies</h2>
            
            <div class="strategy-card">
                <div class="strategy-title">üèÜ Best Player Available (BPA)</div>
                <div class="strategy-desc">Default strategy - selects the highest-ranked available player regardless of position</div>
                <div class="priority-list">
                    <div class="priority-item">
                        <div class="priority-rank">1</div>
                        <div>Check overall player ranking</div>
                    </div>
                    <div class="priority-item">
                        <div class="priority-rank">2</div>
                        <div>Filter out drafted players</div>
                    </div>
                    <div class="priority-item">
                        <div class="priority-rank">3</div>
                        <div>Select top remaining player</div>
                    </div>
                </div>
            </div>
            
            <div class="strategy-card">
                <div class="strategy-title">‚öñÔ∏è Balanced Approach</div>
                <div class="strategy-desc">Considers both player ranking and roster construction needs</div>
                <div class="priority-list">
                    <div class="priority-item">
                        <div class="priority-rank">1</div>
                        <div>Calculate position needs</div>
                    </div>
                    <div class="priority-item">
                        <div class="priority-rank">2</div>
                        <div>Apply position weight multipliers</div>
                    </div>
                    <div class="priority-item">
                        <div class="priority-rank">3</div>
                        <div>Balance value vs need</div>
                    </div>
                </div>
            </div>
            
            <div class="strategy-card">
                <div class="strategy-title">üìä Need-Based Selection</div>
                <div class="strategy-desc">Prioritizes filling roster requirements over pure value</div>
                <div class="priority-list">
                    <div class="priority-item">
                        <div class="priority-rank">1</div>
                        <div>Identify critical roster gaps</div>
                    </div>
                    <div class="priority-item">
                        <div class="priority-rank">2</div>
                        <div>Filter by needed positions</div>
                    </div>
                    <div class="priority-item">
                        <div class="priority-rank">3</div>
                        <div>Select best at position</div>
                    </div>
                </div>
            </div>
            
            <div class="info-grid">
                <div class="info-card">
                    <h3>üéØ Selection Factors</h3>
                    <ul>
                        <li>Overall player ranking</li>
                        <li>Position scarcity value</li>
                        <li>Bye week distribution</li>
                        <li>Injury status (if available)</li>
                        <li>Team stack avoidance</li>
                        <li>Roster limit compliance</li>
                    </ul>
                </div>
                <div class="info-card">
                    <h3>üîí Concurrency Control</h3>
                    <ul>
                        <li>Distributed lock on draft_id</li>
                        <li>Atomic state transitions</li>
                        <li>Idempotent pick operations</li>
                        <li>Race condition prevention</li>
                        <li>Automatic lock timeout (30s)</li>
                        <li>Rollback on conflicts</li>
                    </ul>
                </div>
                <div class="info-card">
                    <h3>‚ö° Performance Optimizations</h3>
                    <ul>
                        <li>Cached player rankings</li>
                        <li>Pre-computed position tiers</li>
                        <li>Indexed deadline queries</li>
                        <li>Batch processing for cron</li>
                        <li>Connection pooling</li>
                        <li>Query result caching</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="content-card">
            <h2>Implementation Code</h2>
            
            <div class="code-block">
<span class="comment">// Autopick Strategy Implementation</span>
<span class="keyword">interface</span> AutopickStrategy {
  mode: <span class="string">'bpa'</span> | <span class="string">'balanced'</span> | <span class="string">'need-based'</span>
  excludePositions?: string[]
  preferredPositions?: string[]
  avoidByeWeek?: number
  maxFromSameTeam?: number
}

<span class="keyword">async function</span> <span class="function">executeAutopick</span>(
  draftId: string,
  teamId: string,
  strategy: AutopickStrategy = { mode: <span class="string">'bpa'</span> }
): Promise<DraftPick> {
  <span class="comment">// Acquire distributed lock with timeout</span>
  <span class="keyword">const</span> lock = <span class="keyword">await</span> acquireLock(<span class="string">`draft:${draftId}:pick`</span>, {
    ttl: 30000, <span class="comment">// 30 second timeout</span>
    retries: 3,
    retryDelay: 1000
  })
  
  <span class="keyword">try</span> {
    <span class="comment">// Verify it's still this team's turn</span>
    <span class="keyword">const</span> currentState = <span class="keyword">await</span> getDraftState(draftId)
    <span class="keyword">if</span> (currentState.currentTeamId !== teamId) {
      <span class="keyword">throw new</span> Error(<span class="string">'Not this team\'s turn'</span>)
    }
    
    <span class="comment">// Get available players with caching</span>
    <span class="keyword">const</span> available = <span class="keyword">await</span> getCachedAvailablePlayers(draftId)
    
    <span class="comment">// Get team's current roster</span>
    <span class="keyword">const</span> roster = <span class="keyword">await</span> getTeamRoster(teamId)
    
    <span class="comment">// Apply strategy</span>
    <span class="keyword">let</span> selected: Player
    <span class="keyword">switch</span>(strategy.mode) {
      <span class="keyword">case</span> <span class="string">'bpa'</span>:
        selected = selectBestPlayerAvailable(available)
        <span class="keyword">break</span>
      
      <span class="keyword">case</span> <span class="string">'balanced'</span>:
        selected = selectBalanced(available, roster, strategy)
        <span class="keyword">break</span>
      
      <span class="keyword">case</span> <span class="string">'need-based'</span>:
        selected = selectByNeed(available, roster, strategy)
        <span class="keyword">break</span>
    }
    
    <span class="comment">// Make the pick atomically</span>
    <span class="keyword">const</span> pick = <span class="keyword">await</span> makePick(draftId, teamId, selected.id, {
      isAutopick: <span class="keyword">true</span>,
      strategy: strategy.mode
    })
    
    <span class="comment">// Log autopick event</span>
    <span class="keyword">await</span> logActivity({
      type: <span class="string">'autopick'</span>,
      draftId,
      teamId,
      playerId: selected.id,
      reason: <span class="string">'timer_expired'</span>,
      strategy: strategy.mode,
      timestamp: <span class="keyword">new</span> Date().toISOString()
    })
    
    <span class="keyword">return</span> pick
    
  } <span class="keyword">catch</span> (error) {
    <span class="comment">// Log error and rethrow</span>
    console.error(<span class="string">'Autopick failed:'</span>, error)
    <span class="keyword">await</span> logActivity({
      type: <span class="string">'autopick_error'</span>,
      draftId,
      teamId,
      error: error.message
    })
    <span class="keyword">throw</span> error
    
  } <span class="keyword">finally</span> {
    <span class="comment">// Always release lock</span>
    <span class="keyword">await</span> releaseLock(lock)
  }
}

<span class="comment">// Position need calculation</span>
<span class="keyword">function</span> <span class="function">calculatePositionNeeds</span>(roster: Player[]): PositionWeights {
  <span class="keyword">const</span> counts = roster.reduce((acc, player) => {
    acc[player.position] = (acc[player.position] || 0) + 1
    <span class="keyword">return</span> acc
  }, {} <span class="keyword">as</span> Record<string, number>)
  
  <span class="comment">// Return weight multipliers based on needs</span>
  <span class="keyword">return</span> {
    QB: counts.QB >= 2 ? 0.5 : 1.0,
    RB: counts.RB >= 4 ? 0.6 : 1.0,
    WR: counts.WR >= 4 ? 0.6 : 1.0,
    TE: counts.TE >= 2 ? 0.4 : 1.0,
    K: counts.K >= 1 ? 0.2 : 1.0,
    DEF: counts.DEF >= 1 ? 0.2 : 1.0
  }
}

<span class="comment">// Cron job for safety net</span>
<span class="keyword">export async function</span> <span class="function">autopickSweep</span>() {
  <span class="comment">// Find all drafts with expired timers</span>
  <span class="keyword">const</span> expiredDrafts = <span class="keyword">await</span> db.draft_states.findMany({
    where: {
      deadline: { lte: <span class="keyword">new</span> Date() },
      status: <span class="string">'active'</span>
    }
  })
  
  <span class="comment">// Process each expired draft</span>
  <span class="keyword">for</span> (<span class="keyword">const</span> draft <span class="keyword">of</span> expiredDrafts) {
    <span class="keyword">try</span> {
      <span class="keyword">await</span> executeAutopick(
        draft.draftId,
        draft.currentTeamId,
        { mode: <span class="string">'bpa'</span> }
      )
    } <span class="keyword">catch</span> (error) {
      <span class="comment">// Log but don't stop processing other drafts</span>
      console.error(<span class="string">`Sweep failed for draft ${draft.draftId}:`</span>, error)
    }
  }
}
            </div>
        </div>
    </div>
    
    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
                primaryColor: '#ec4899',
                primaryTextColor: '#1a202c',
                primaryBorderColor: '#be185d',
                lineColor: '#ec4899',
                secondaryColor: '#fdf4ff',
                tertiaryColor: '#fae8ff'
            },
            sequence: {
                diagramMarginX: 50,
                diagramMarginY: 30,
                actorMargin: 50,
                width: 150,
                height: 65,
                boxMargin: 10,
                boxTextMargin: 5,
                noteMargin: 10,
                messageMargin: 35
            }
        });
    </script>
</body>
</html>